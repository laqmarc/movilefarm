const SAVE_KEY = "movile-farm-save-v4";

const CONFIG = {
  gridRows: 18,
  gridCols: 18,
  cellSizePx: 62,
  panDragThresholdPx: 10,
  minZoom: 0.4,
  maxZoom: 2.2,
  autosaveMs: 4000,
  stonePrice: 1,
  woodPrice: 2,
  sandPrice: 2,
  waterPrice: 1,
  ironPrice: 4,
  coalPrice: 3,
  copperPrice: 5,
  oilPrice: 6,
  aluminumPrice: 7,
  quartzPrice: 6,
  sulfurPrice: 5,
  goldPrice: 16,
  lithiumPrice: 14,
  partsPrice: 9,
  steelPrice: 11,
  platesPrice: 10,
  modulesPrice: 18,
  circuitsPrice: 22,
  framesPrice: 16,
  siliconPrice: 9,
  plasticPrice: 10,
  steamPrice: 8,
  rubberPrice: 12,
  wiringPrice: 14,
  microchipsPrice: 26,
  batteriesPrice: 24,
  glassPrice: 12,
  acidPrice: 12,
  fiberPrice: 24,
  compositesPrice: 44,
  superalloyPrice: 42,
  quantumchipsPrice: 72,
  marketVolatility: 0.32,
  marketReversion: 0.11,
  marketMinMultiplier: 0.65,
  marketMaxMultiplier: 1.55,
  ironUnlockCost: 380,
  forgeUnlockCost: 700,
  advancedMinesUnlockCost: 1100,
  assemblerUnlockCost: 1700,
  materialsUnlockCost: 3600,
  endgameUnlockCost: 7400,
  autoSellRatePerSec: 8,
  initialMoney: 170,
  minerBaseCost: 30,
  minerCostScale: 1.45,
  woodMinerBaseCost: 52,
  woodMinerCostScale: 1.48,
  sandMinerBaseCost: 58,
  sandMinerCostScale: 1.49,
  waterMinerBaseCost: 54,
  waterMinerCostScale: 1.47,
  ironMinerBaseCost: 85,
  ironMinerCostScale: 1.52,
  coalMinerBaseCost: 110,
  coalMinerCostScale: 1.5,
  copperMinerBaseCost: 122,
  copperMinerCostScale: 1.52,
  oilMinerBaseCost: 138,
  oilMinerCostScale: 1.54,
  aluminumMinerBaseCost: 145,
  aluminumMinerCostScale: 1.54,
  quartzMinerBaseCost: 152,
  quartzMinerCostScale: 1.54,
  sulfurMinerBaseCost: 145,
  sulfurMinerCostScale: 1.53,
  goldMinerBaseCost: 260,
  goldMinerCostScale: 1.6,
  lithiumMinerBaseCost: 240,
  lithiumMinerCostScale: 1.59,
  forgeBaseCost: 145,
  forgeCostScale: 1.55,
  assemblerBaseCost: 210,
  assemblerCostScale: 1.54,
  forgeWoodPerUnit: 0.7,
  forgeIronPerUnit: 0.45,
  forgePartsPerUnit: 0.62,
  forgeSteelIronPerUnit: 0.82,
  forgeSteelCoalPerUnit: 0.58,
  forgeSteelPerUnit: 0.5,
  forgePlatesCopperPerUnit: 0.88,
  forgePlatesCoalPerUnit: 0.42,
  forgePlatesPerUnit: 0.55,
  forgeSiliconSandPerUnit: 1.25,
  forgeSiliconCoalPerUnit: 0.34,
  forgeSiliconPerUnit: 0.72,
  forgePlasticOilPerUnit: 1.04,
  forgePlasticCoalPerUnit: 0.28,
  forgePlasticPerUnit: 0.78,
  forgeSteamWaterPerUnit: 1.18,
  forgeSteamCoalPerUnit: 0.25,
  forgeSteamPerUnit: 0.96,
  forgeGlassSandPerUnit: 1.08,
  forgeGlassQuartzPerUnit: 0.84,
  forgeGlassPerUnit: 0.74,
  forgeAcidSulfurPerUnit: 1.04,
  forgeAcidWaterPerUnit: 0.68,
  forgeAcidPerUnit: 0.72,
  forgeSuperalloyGoldPerUnit: 0.66,
  forgeSuperalloyAluminumPerUnit: 0.74,
  forgeSuperalloyPerUnit: 0.46,
  assemblerPartsPerUnit: 0.78,
  assemblerPlatesPerUnit: 0.65,
  assemblerModulesPerUnit: 0.48,
  assemblerCircuitPartsPerUnit: 0.72,
  assemblerCircuitCopperPerUnit: 0.8,
  assemblerCircuitsPerUnit: 0.52,
  assemblerFrameSteelPerUnit: 0.64,
  assemblerFramePlatesPerUnit: 0.7,
  assemblerFramesPerUnit: 0.5,
  assemblerRubberOilPerUnit: 0.92,
  assemblerRubberWoodPerUnit: 0.24,
  assemblerRubberPerUnit: 0.72,
  assemblerWiringCopperPerUnit: 0.84,
  assemblerWiringRubberPerUnit: 0.46,
  assemblerWiringPerUnit: 0.66,
  assemblerMicrochipsSiliconPerUnit: 0.92,
  assemblerMicrochipsPlasticPerUnit: 0.56,
  assemblerMicrochipsCircuitsPerUnit: 0.34,
  assemblerMicrochipsPerUnit: 0.52,
  assemblerBatteriesAluminumPerUnit: 0.72,
  assemblerBatteriesCopperPerUnit: 0.62,
  assemblerBatteriesPlasticPerUnit: 0.46,
  assemblerBatteriesPerUnit: 0.56,
  assemblerFiberGlassPerUnit: 0.82,
  assemblerFiberPlasticPerUnit: 0.46,
  assemblerFiberPerUnit: 0.62,
  assemblerCompositesFiberPerUnit: 0.66,
  assemblerCompositesAluminumPerUnit: 0.54,
  assemblerCompositesPerUnit: 0.48,
  assemblerQuantumchipsLithiumPerUnit: 0.62,
  assemblerQuantumchipsMicrochipsPerUnit: 0.58,
  assemblerQuantumchipsGoldPerUnit: 0.34,
  assemblerQuantumchipsPerUnit: 0.46,
  poleBaseCost: 18,
  poleCostScale: 1.22,
  cableCost: 6,
  cableMaxDistance: 3,
  cableMaintenancePerSec: 0.06,
  dragSnapRadiusPx: 54,
  minerUpgradeBaseCost: 65,
  minerUpgradeScale: 1.8,
  warehouseUpgradeBaseCost: 70,
  warehouseUpgradeScale: 1.75,
  marketUpgradeBaseCost: 60,
  marketUpgradeScale: 1.65,
  baseCapacity: 140,
  capacityPerWarehouseLevel: 110,
};

const dom = {
  moneyValue: document.getElementById("moneyValue"),
  stoneValue: document.getElementById("stoneValue"),
  productionValue: document.getElementById("productionValue"),
  resourceStrip: document.getElementById("resourceStrip"),
  resourcePanel: document.getElementById("resourcePanel"),
  recipePanel: document.getElementById("recipePanel"),
  minerCostValue: document.getElementById("minerCostValue"),
  woodMinerCostValue: document.getElementById("woodMinerCostValue"),
  sandMinerCostValue: document.getElementById("sandMinerCostValue"),
  waterMinerCostValue: document.getElementById("waterMinerCostValue"),
  ironMinerCostValue: document.getElementById("ironMinerCostValue"),
  coalMinerCostValue: document.getElementById("coalMinerCostValue"),
  copperMinerCostValue: document.getElementById("copperMinerCostValue"),
  oilMinerCostValue: document.getElementById("oilMinerCostValue"),
  aluminumMinerCostValue: document.getElementById("aluminumMinerCostValue"),
  quartzMinerCostValue: document.getElementById("quartzMinerCostValue"),
  sulfurMinerCostValue: document.getElementById("sulfurMinerCostValue"),
  goldMinerCostValue: document.getElementById("goldMinerCostValue"),
  lithiumMinerCostValue: document.getElementById("lithiumMinerCostValue"),
  forgeCostValue: document.getElementById("forgeCostValue"),
  assemblerCostValue: document.getElementById("assemblerCostValue"),
  poleCostValue: document.getElementById("poleCostValue"),
  cableCostValue: document.getElementById("cableCostValue"),
  cableRangeValue: document.getElementById("cableRangeValue"),
  autoSellValue: document.getElementById("autoSellValue"),
  maintenanceValue: document.getElementById("maintenanceValue"),
  marketShiftValue: document.getElementById("marketShiftValue"),
  researchPointsValue: document.getElementById("researchPointsValue"),
  prestigeValue: document.getElementById("prestigeValue"),
  objectivesValue: document.getElementById("objectivesValue"),
  modeLabel: document.getElementById("modeLabel"),
  mapBoard: document.getElementById("mapBoard"),
  mapWorld: document.getElementById("mapWorld"),
  gridCells: document.getElementById("gridCells"),
  cableLayer: document.getElementById("cableLayer"),
  flowLegend: document.getElementById("flowLegend"),
  toolBuyModeBtn: document.getElementById("toolBuyModeBtn"),
  toolCableModeBtn: document.getElementById("toolCableModeBtn"),
  toolCableDeleteModeBtn: document.getElementById("toolCableDeleteModeBtn"),
  toolInspectModeBtn: document.getElementById("toolInspectModeBtn"),
  toolUpgradeBtn: document.getElementById("toolUpgradeBtn"),
  toolRecipeBtn: document.getElementById("toolRecipeBtn"),
  toolRecipeListBtn: document.getElementById("toolRecipeListBtn"),
  toolDeleteBtn: document.getElementById("toolDeleteBtn"),
  techUnlockIronBtn: document.getElementById("techUnlockIronBtn"),
  toolSellBtn: document.getElementById("toolSellBtn"),
  buyMinerTypeBtn: document.getElementById("buyMinerTypeBtn"),
  buyWoodMinerTypeBtn: document.getElementById("buyWoodMinerTypeBtn"),
  buySandMinerTypeBtn: document.getElementById("buySandMinerTypeBtn"),
  buyWaterMinerTypeBtn: document.getElementById("buyWaterMinerTypeBtn"),
  buyIronMinerTypeBtn: document.getElementById("buyIronMinerTypeBtn"),
  buyCoalMinerTypeBtn: document.getElementById("buyCoalMinerTypeBtn"),
  buyCopperMinerTypeBtn: document.getElementById("buyCopperMinerTypeBtn"),
  buyOilMinerTypeBtn: document.getElementById("buyOilMinerTypeBtn"),
  buyAluminumMinerTypeBtn: document.getElementById("buyAluminumMinerTypeBtn"),
  buyQuartzMinerTypeBtn: document.getElementById("buyQuartzMinerTypeBtn"),
  buySulfurMinerTypeBtn: document.getElementById("buySulfurMinerTypeBtn"),
  buyGoldMinerTypeBtn: document.getElementById("buyGoldMinerTypeBtn"),
  buyLithiumMinerTypeBtn: document.getElementById("buyLithiumMinerTypeBtn"),
  buyForgeTypeBtn: document.getElementById("buyForgeTypeBtn"),
  buyAssemblerTypeBtn: document.getElementById("buyAssemblerTypeBtn"),
  buyPoleTypeBtn: document.getElementById("buyPoleTypeBtn"),
  toggleAutoSellBtn: document.getElementById("toggleAutoSellBtn"),
  cycleFlowFilterBtn: document.getElementById("cycleFlowFilterBtn"),
  sell10Btn: document.getElementById("sell10Btn"),
  sellAllBtn: document.getElementById("sellAllBtn"),
  selectedTypeValue: document.getElementById("selectedTypeValue"),
  selectedLevelValue: document.getElementById("selectedLevelValue"),
  selectedUpgradeCostValue: document.getElementById("selectedUpgradeCostValue"),
  selectedRecipeValue: document.getElementById("selectedRecipeValue"),
  clearSelectionBtn: document.getElementById("clearSelectionBtn"),
  openTutorialBtn: document.getElementById("openTutorialBtn"),
  resetPersistenceBtn: document.getElementById("resetPersistenceBtn"),
  contractOffer: document.getElementById("contractOffer"),
  researchTree: document.getElementById("researchTree"),
  objectivesPanel: document.getElementById("objectivesPanel"),
  prestigeBtn: document.getElementById("prestigeBtn"),
  tutorialBox: document.getElementById("tutorialBox"),
  tutorialOverlay: document.getElementById("tutorialOverlay"),
  acceptContractBtn: document.getElementById("acceptContractBtn"),
  deliverContractBtn: document.getElementById("deliverContractBtn"),
  rerollContractBtn: document.getElementById("rerollContractBtn"),
  toast: document.getElementById("toast"),
};

let state = null;
let lastTick = 0;
let elapsedSinceSave = 0;
let toastTimer = null;
const cellRefs = new Map();
const pointerState = {
  activePointerId: null,
  points: new Map(),
  pointerDown: false,
  panActive: false,
  moved: false,
  pinchActive: false,
  startX: 0,
  startY: 0,
  startCameraX: 0,
  startCameraY: 0,
  pinchStartDistance: 0,
  pinchStartZoom: 1,
  pinchAnchorWorldX: 0,
  pinchAnchorWorldY: 0,
};

function createDefaultState() {
  return {
    money: CONFIG.initialMoney,
    resources: {
      stone: 0,
      wood: 0,
      sand: 0,
      water: 0,
      iron: 0,
      coal: 0,
      copper: 0,
      oil: 0,
      aluminum: 0,
      quartz: 0,
      sulfur: 0,
      gold: 0,
      lithium: 0,
      parts: 0,
      steel: 0,
      plates: 0,
      modules: 0,
      circuits: 0,
      frames: 0,
      silicon: 0,
      plastic: 0,
      steam: 0,
      rubber: 0,
      wiring: 0,
      microchips: 0,
      batteries: 0,
      glass: 0,
      acid: 0,
      fiber: 0,
      composites: 0,
      superalloy: 0,
      quantumchips: 0,
      wastedStone: 0,
      wastedWood: 0,
      wastedSand: 0,
      wastedWater: 0,
      wastedIron: 0,
      wastedCoal: 0,
      wastedCopper: 0,
      wastedOil: 0,
      wastedAluminum: 0,
      wastedQuartz: 0,
      wastedSulfur: 0,
      wastedGold: 0,
      wastedLithium: 0,
      wastedParts: 0,
      wastedSteel: 0,
      wastedPlates: 0,
      wastedModules: 0,
      wastedCircuits: 0,
      wastedFrames: 0,
      wastedSilicon: 0,
      wastedPlastic: 0,
      wastedSteam: 0,
      wastedRubber: 0,
      wastedWiring: 0,
      wastedMicrochips: 0,
      wastedBatteries: 0,
      wastedGlass: 0,
      wastedAcid: 0,
      wastedFiber: 0,
      wastedComposites: 0,
      wastedSuperalloy: 0,
      wastedQuantumchips: 0,
    },
    nodes: [
      { id: "warehouse-1", type: "warehouse", row: 3, col: 2, level: 1, fixed: true },
      { id: "market-1", type: "market", row: 3, col: 5, level: 1, fixed: true },
      { id: "miner-1", type: "miner", row: 1, col: 1, level: 1, fixed: false },
    ],
    cables: [edgeKey("miner-1", "warehouse-1"), edgeKey("warehouse-1", "market-1")],
    nextMinerId: 2,
    nextWoodMinerId: 1,
    nextSandMinerId: 1,
    nextWaterMinerId: 1,
    nextIronMinerId: 1,
    nextCoalMinerId: 1,
    nextCopperMinerId: 1,
    nextOilMinerId: 1,
    nextAluminumMinerId: 1,
    nextQuartzMinerId: 1,
    nextSulfurMinerId: 1,
    nextGoldMinerId: 1,
    nextLithiumMinerId: 1,
    nextForgeId: 1,
    nextAssemblerId: 1,
    nextPoleId: 1,
    autoSellEnabled: false,
    tech: {
      ironUnlocked: false,
      forgeUnlocked: false,
      advancedMinesUnlocked: false,
      assemblerUnlocked: false,
      materialsUnlocked: false,
      endgameUnlocked: false,
    },
    camera: {
      x: 0,
      y: 0,
      zoom: 1,
    },
    economy: {
      lastMaintenancePerSec: 0,
      recipeActivity: {},
    },
    market: {
      multipliers: {},
      averageMultiplier: 1,
      trend: 0,
    },
    research: {
      points: 0,
      unlocked: {},
    },
    progression: {
      prestigeLevel: 0,
      totalMoneyEarned: 0,
      totalSoldUnits: 0,
      contractsCompleted: 0,
      contractsPremiumCompleted: 0,
      cablesBuilt: 0,
      nodesBuilt: 0,
      produced: {},
      objectivesCompleted: {},
      prestigeCount: 0,
      buffs: {},
    },
    tutorial: {
      completed: false,
      dismissed: false,
      step: 0,
    },
    contract: {
      offer: createContractOffer(1),
      active: null,
      lastId: 1,
    },
    ui: {
      mode: "inspect",
      buyType: "miner",
      flowResource: "all",
      resourcePanelOpen: false,
      recipePanelOpen: false,
      tutorialExpanded: true,
      selectedNodeId: null,
      pendingSourceId: null,
      drag: {
        active: false,
        sourceId: null,
        pointerX: 0,
        pointerY: 0,
        hoverCellKey: null,
        snapTargetId: null,
      },
    },
  };
}

function defaultUi() {
  return createDefaultState().ui;
}

function loadState() {
  const fallback = createDefaultState();
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return fallback;

  try {
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== "object") return fallback;

    return {
      ...fallback,
      ...parsed,
      resources: { ...fallback.resources, ...(parsed.resources || {}) },
      nodes: Array.isArray(parsed.nodes) ? parsed.nodes : fallback.nodes,
      cables: Array.isArray(parsed.cables) ? parsed.cables : fallback.cables,
      camera: { ...fallback.camera, ...(parsed.camera || {}) },
      tech: { ...fallback.tech, ...(parsed.tech || {}) },
      economy: { ...fallback.economy, ...(parsed.economy || {}) },
      market: { ...fallback.market, ...(parsed.market || {}) },
      research: {
        ...fallback.research,
        ...(parsed.research || {}),
        unlocked: { ...fallback.research.unlocked, ...((parsed.research && parsed.research.unlocked) || {}) },
      },
      progression: {
        ...fallback.progression,
        ...(parsed.progression || {}),
        produced: { ...fallback.progression.produced, ...((parsed.progression && parsed.progression.produced) || {}) },
        objectivesCompleted: {
          ...fallback.progression.objectivesCompleted,
          ...((parsed.progression && parsed.progression.objectivesCompleted) || {}),
        },
        buffs: {
          ...fallback.progression.buffs,
          ...((parsed.progression && parsed.progression.buffs) || {}),
        },
      },
      tutorial: { ...fallback.tutorial, ...(parsed.tutorial || {}) },
      contract: {
        ...fallback.contract,
        ...(parsed.contract || {}),
        offer: normalizeContract((parsed.contract && parsed.contract.offer) || fallback.contract.offer),
        active: normalizeContract((parsed.contract && parsed.contract.active) || null),
      },
      ui: {
        ...defaultUi(),
        ...(parsed.ui || {}),
        drag: {
          ...defaultUi().drag,
          ...((parsed.ui && parsed.ui.drag) || {}),
        },
      },
    };
  } catch {
    return fallback;
  }
}

function saveState() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
}

